<html>
  <head>
    <title>Interleaving deck.gl with Mapbox Layers using MapboxOverlay</title>

    <script src="https://unpkg.com/deck.gl@^9.0.0-beta/dist.min.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.2.0/mapbox-gl.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v3.2.0/mapbox-gl.css"
      rel="stylesheet"
    />
  </head>

  <body style="margin: 0">
    <h2>Title:</h2>
    <div id="map" style="width: 75%; height: 75%"></div>
    <div>
      <label for="year-slider">
        Filter by year:
        <input
          type="range"
          id="year-slider"
          min="2004"
          max="2024"
          step="1"
          value="2024"
        />
        <span id="year-value">2024</span>
      </label>
    </div>
  </body>

  <script type="text/javascript">
    const {
      MapboxOverlay,
      ScatterplotLayer,
      ArcLayer,
      GeoJsonLayer,
      COORDINATE_SYSTEM,
      AmbientLight,
      PointLight,
      LightingEffect,
    } = deck;

    mapboxgl.accessToken =
      "pk.eyJ1IjoiYXV0dW1uYXJ0aXN0IiwiYSI6ImNtOTFtdTdvejAycTQyaW42aDA4M3duMGoifQ.ySZoxVyD5VLs_LUcDp3jPA";

    const map = new mapboxgl.Map({
      container: "map",
      style: "mapbox://styles/autumnartist/cm95dpgq200aw01qu4zs00wkv",
      center: [-71.057083, 42.361145],
      zoom: 10,
      pitch: 45,
      antialias: true,
      projection: "mercator",
    });

    let corpData;
    let geojson;
    let deckOverlay;

    async function loadData() {
      corpData = await d3.csv("/merged_dataset_full.csv").then((data) => {
        const corpMap = new Map();

        data.forEach((d) => {
          const hood = d.Neighborhood.trim();
          const year = +d.Year;
          const rate = +d.corp_own_rate;
          if (!corpMap.has(hood)) corpMap.set(hood, {});
          corpMap.get(hood)[year] = rate;
        });
        return corpMap;
      });
      console.log(corpData);

      geojson = await fetch("/boston_neighborhoods.geojson").then((res) =>
        res.json()
      );
    }

    async function init() {
      await loadData();
      deckOverlay = new MapboxOverlay({
        interleaved: true,
        layers: [createGeoJsonLayer(1, geojson, corpData, 2024)],
      });
      map.addControl(deckOverlay);
      console.log("initizlized");

      // Assuming map is already initialized here
      const yearSlider = document.getElementById("year-slider");
      const yearValue = document.getElementById("year-value");

      yearSlider.addEventListener("input", () => {
        yearValue.textContent = yearSlider.value;
        const selectedYear = parseInt(yearSlider.value);
        deckOverlay.setProps({
          layers: [createGeoJsonLayer(1, geojson, corpData, selectedYear)],
        });
      });

      // Optionally trigger it once on load
      yearSlider.dispatchEvent(new Event("input"));
    }
    document.addEventListener("DOMContentLoaded", () => {
      init();
    });

    const ambientLight = new AmbientLight({
      color: [255, 230, 200],
      intensity: 1.0,
    });

    const pointLight = new PointLight({
      color: [255, 230, 200],
      intensity: 0.8,
      position: [-71.057083, 42.361145, 8000], // longitude, latitude, altitude
    });

    const lightingEffect = new LightingEffect({ ambientLight, pointLight });

    map.on("load", async () => {
      render();
    });

    const minRate = 0.0;
    const maxRate = 0.69;
    const colorScale = d3
      .scaleLinear()
      // .domain([minRate, maxRate])
      .domain(d3.range(minRate, maxRate, (maxRate - minRate) / 6)) // 6 colors â†’ 5 segments
      .range([
        "#4593b6", // blue
        "#77d8cc", // teal
        "#c4ff6f", // light green
        "#f4ad62", // orange
        "#c3424f", // red
      ])

      .interpolate(d3.interpolateLab);
    const elevationScale = d3
      .scaleLinear()
      .domain([minRate, maxRate]) // Adjust this based on your min and max rate values
      .range([100, 3000]);

    function createGeoJsonLayer(scale, geojson, corpData, currYear) {
      console.log("check check");
      return new GeoJsonLayer({
        id: "boston-3d",
        data: geojson,
        extruded: true,
        wireframe: false,
        pickable: true,
        effects: [lightingEffect],
        material: {
          ambient: 0.6,
          diffuse: 0.8,
          shininess: 32,
          specularColor: [60, 60, 60],
        },
        getElevation: (f) => {
          const name = f.properties.blockgr2020_ctr_neighb_name?.trim();
          const yearRates = corpData.get(name);
          console.log("name:", name);
          console.log("year:", currYear);
          const rate = yearRates ? yearRates[currYear] : undefined;
          console.log("rate; ", rate);
          const baseHeight = rate ? elevationScale(rate) : 100;
          return baseHeight * scale;
        },
        getFillColor: (f) => {
          const name = f.properties.blockgr2020_ctr_neighb_name?.trim();
          const yearRates = corpData.get(name);
          const val = yearRates ? yearRates[currYear] : undefined;
          if (val == null || isNaN(val)) return [200, 200, 200, 180];
          const c = d3.color(colorScale(val));
          return [c.r, c.g, c.b, c.opacity * 255];
        },
        updateTriggers: {
          getElevation: [scale, currYear],
          getFillColor: currYear,
        },

        coordinateSystem: COORDINATE_SYSTEM.LNGLAT,
      });
    }

    async function render(currYear = 2024) {
      console.log("render bitch");
      const firstLabelLayerId = map
        .getStyle()
        .layers.find((layer) => layer.type === "symbol").id;

      map.addLayer(
        {
          id: "3d-buildings",
          source: "composite",
          "source-layer": "building",
          filter: ["==", "extrude", "true"],
          type: "fill-extrusion",
          minzoom: 15,
          paint: {
            "fill-extrusion-color": "#aaa",
            "fill-extrusion-height": [
              "interpolate",
              ["linear"],
              ["zoom"],
              15,
              0,
              15.05,
              ["get", "height"],
            ],
            "fill-extrusion-base": [
              "interpolate",
              ["linear"],
              ["zoom"],
              15,
              0,
              15.05,
              ["get", "min_height"],
            ],
            "fill-extrusion-opacity": 0.6,
          },
        },
        firstLabelLayerId
      );

      let scaleFactor = 0; // start small
      const maxScale = 1;
      const animationDuration = 2000; // ms
      const animationStart = Date.now();

      function animate() {
        const now = Date.now();
        const elapsed = now - animationStart;
        scaleFactor = Math.min(elapsed / animationDuration, maxScale);
        deckOverlay.setProps({
          layers: [
            createGeoJsonLayer(scaleFactor, geojson, corpData, currYear),
          ],
        });

        if (scaleFactor < maxScale) {
          requestAnimationFrame(animate);
        }
      }
      animate();
    }
  </script>
</html>
