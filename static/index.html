<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Boston Corporate Ownership 3‑D Map</title>

    <!--‑‑ External libraries ‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑ -->
    <script src="https://unpkg.com/deck.gl@^9.0.0-beta/dist.min.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.2.0/mapbox-gl.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link
      rel="stylesheet"
      href="https://api.mapbox.com/mapbox-gl-js/v3.2.0/mapbox-gl.css"
    />

    <!--‑‑ Styles ‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑‑ -->
    <style>
      html,
      body {
        margin: 0;
        font-family: system-ui, sans-serif;
      }

      /* Header ------------------------------------------------------------ */
      #header {
        position: sticky;
        top: 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 2rem;
        background: #fff;
        z-index: 10;
      }
      #filter {
        width: 300px;
      }
      #filter label {
        display: block;
        font-size: 0.9rem;
        margin-bottom: 0.25rem;
      }

      /* Map container ----------------------------------------------------- */
      #map-wrapper {
        width: 80%;
        margin: 0 auto;
      }
      #map {
        width: 100%;
        height: 75vh;
      }

      /* Tooltip ----------------------------------------------------------- */
      #tooltip {
        position: absolute;
        display: none;
        background: rgba(0, 0, 0, 0.8);
        color: #fff;
        font-size: 13px;
        padding: 8px 10px;
        border-radius: 4px;
        pointer-events: none;
        z-index: 999;
      }

      /* Legend ------------------------------------------------------------ */
      #legend-corp {
        position: absolute;
        bottom: 1rem;
        right: 2rem;
        background: #fff;
        padding: 10px 15px;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        font-size: 12px;
        width: 160px;
        z-index: 999;
      }
      #legend-elevation {
        position: absolute;
        bottom: 1rem;
        right: 15rem;
        background: #fff;
        padding: 10px 15px;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        font-size: 12px;
        width: 200px;
        z-index: 999;
      }
      #legend-gradient {
        height: 12px;
        margin: 8px 0;
        border: 1px solid #ccc;
        border-radius: 4px;
        background: linear-gradient(
          to right,
          #4593b6,
          #77d8cc,
          #f4ad62,
          #c3424f
        );
      }
    </style>
  </head>

  <body>
    <!--‑‑ Header with slider --------------------------------------------- -->
    <div id="header">
      <h2>Corporate Ownership Rates in Boston Neighborhoods</h2>

      <div id="filter">
        <label for="year-slider">
          Filter by year: <span id="year-value">2024</span>
        </label>
        <input
          id="year-slider"
          type="range"
          min="2004"
          max="2024"
          step="1"
          value="2024"
          style="width: 100%"
        />
        <div
          style="
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: #555;
          "
        >
          <span>2004</span><span>2024</span>
        </div>
      </div>
    </div>

    <!--‑‑ Map ------------------------------------------------------------- -->
    <div id="map-wrapper"><div id="map"></div></div>

    <!--‑‑ Tooltip & Legend ----------------------------------------------- -->
    <div id="tooltip"></div>

    <div id="legend-corp">
      <strong>Corporate Ownership Rate</strong>
      <div id="legend-gradient"></div>
      <div style="display: flex; justify-content: space-between">
        <span>0%</span><span>69%</span>
      </div>
    </div>
    <div id="legend-elevation">
      <strong>Median House Price (Elevation)</strong>
      <div
        style="display: flex; flex-direction: column; gap: 4px; margin-top: 6px"
      >
        <div style="display: flex; align-items: center">
          <div
            style="
              width: 20px;
              height: 6px;
              background: #999;
              margin-right: 8px;
            "
          ></div>
          <span>$200k</span>
        </div>
        <div style="display: flex; align-items: center">
          <div
            style="
              width: 40px;
              height: 6px;
              background: #999;
              margin-right: 8px;
            "
          ></div>
          <span>$650k</span>
        </div>
        <div style="display: flex; align-items: center">
          <div
            style="
              width: 60px;
              height: 6px;
              background: #999;
              margin-right: 8px;
            "
          ></div>
          <span>$1.3M</span>
        </div>
      </div>
    </div>

    <!--‑‑ Application script --------------------------------------------- -->
    <script>
      (function () {
        /* ------------------------------------------------------------------
         *  Constants & configuration
         * ----------------------------------------------------------------*/
        const START_YEAR = 2004;
        const END_YEAR = 2024;
        const INITIAL_YEAR = 2024;

        const {
          MapboxOverlay,
          GeoJsonLayer,
          COORDINATE_SYSTEM,
          AmbientLight,
          PointLight,
          LightingEffect,
        } = deck;

        mapboxgl.accessToken =
          "pk.eyJ1IjoiYXV0dW1uYXJ0aXN0IiwiYSI6ImNtOTFtdTdvejAycTQyaW42aDA4M3duMGoifQ.ySZoxVyD5VLs_LUcDp3jPA";

        /* ------------------------------------------------------------------
         *  DOM references
         * ----------------------------------------------------------------*/
        const mapEl = document.getElementById("map");
        const sliderEl = document.getElementById("year-slider");
        const sliderLabel = document.getElementById("year-value");
        const tooltipEl = document.getElementById("tooltip");

        /* ------------------------------------------------------------------
         *  State
         * ----------------------------------------------------------------*/
        let geojson = null;
        let data = null;
        let deckOverlay = null;

        /* ------------------------------------------------------------------
         *  Map initialisation
         * ----------------------------------------------------------------*/
        const map = new mapboxgl.Map({
          container: mapEl,
          style: "mapbox://styles/autumnartist/cm95dpgq200aw01qu4zs00wkv",
          // center: [-71.057083, 42.361145],
          center: [-71.057083, 42.3],
          zoom: 10,
          pitch: 45,
          antialias: true,
          projection: "mercator",
        });

        /* ------------------------------------------------------------------
         *  Lights
         * ----------------------------------------------------------------*/
        const ambientLight = new AmbientLight({
          color: [255, 230, 200],
          intensity: 1.0,
        });
        const pointLight = new PointLight({
          color: [255, 230, 200],
          intensity: 0.8,
          position: [-71.057083, 42.361145, 8000],
        });
        const lightingEffect = new LightingEffect({ ambientLight, pointLight });

        /* ------------------------------------------------------------------
         *  Scales
         * ----------------------------------------------------------------*/
        const minRate = 0.0;
        const maxRate = 0.69;

        const colorScale = d3
          .scaleLinear()
          .domain(d3.range(minRate, maxRate, (maxRate - minRate) / 6))
          .range(["#4593b6", "#77d8cc", "#f4ad62", "#c3424f"])
          .interpolate(d3.interpolateLab);

        // const elevationScale = d3
        //   .scaleLinear()
        //   .domain([minRate, maxRate])
        //   .range([100, 3000]);
        const minPrice = 200000;
        const maxPrice = 1300000;
        const elevationScale = d3
          .scaleLinear()
          .domain([minPrice, maxPrice]) // min and max home prices
          .range([100, 3000]);

        /* ------------------------------------------------------------------
         *  Data loading
         * ----------------------------------------------------------------*/
        async function loadData() {
          const [csv, json] = await Promise.all([
            d3.csv("merged_dataset_full.csv"),
            fetch("boston_neighborhoods.geojson").then((r) => r.json()),
          ]);

          data = csv.reduce((acc, d) => {
            const hood = d.Neighborhood.trim();
            const year = +d.Year;
            const corpRate = parseFloat(d.corp_own_rate);
            const housePrice = parseFloat(d.Median_House_Price);

            acc[hood] = acc[hood] || {};
            // acc[hood][+d.Year] = +d.corp_own_rate;
            acc[hood][year] = {
              corp_own_rate: isNaN(corpRate) ? null : corpRate,
              median_house_price: isNaN(housePrice) ? null : housePrice,
            };
            return acc;
          }, {});

          geojson = json;
          console.log(data);
        }

        /* ------------------------------------------------------------------
         *  Layer factory
         * ----------------------------------------------------------------*/
        function makeLayer({ scale = 1, year }) {
          return new GeoJsonLayer({
            id: "boston-3d",
            data: geojson,
            pickable: true,
            extruded: true,
            wireframe: false,
            effects: [lightingEffect],
            coordinateSystem: COORDINATE_SYSTEM.LNGLAT,

            material: {
              ambient: 0.6,
              diffuse: 0.8,
              shininess: 32,
              specularColor: [60, 60, 60],
            },

            getElevation: (f) => {
              const hood = f.properties.blockgr2020_ctr_neighb_name?.trim();
              // const rate = data[hood]?.[year];
              // const h = rate != null ? elevationScale(rate) : 100;
              // return h * scale;
              const value = data[hood]?.[year]?.median_house_price;
              return value != null ? elevationScale(value) * scale : 100;
            },

            getFillColor: (f) => {
              const hood = f.properties.blockgr2020_ctr_neighb_name?.trim();
              // const rate = data[hood]?.[year];
              const rate = data[hood]?.[year]?.corp_own_rate;
              if (rate == null || isNaN(rate)) return [200, 200, 200, 180];
              const c = d3.color(colorScale(rate));
              return [c.r, c.g, c.b, c.opacity * 255];
            },

            onHover: ({ x, y, object }) => {
              if (!object) {
                tooltipEl.style.display = "none";
                return;
              }

              const hood =
                object.properties.blockgr2020_ctr_neighb_name?.trim();
              const rate = data[hood]?.[year];
              tooltipEl.style.display = "block";
              tooltipEl.style.left = `${x + 10}px`;
              tooltipEl.style.top = `${y + 10}px`;
              tooltipEl.innerHTML = `
            <strong>${hood}</strong><br/>
            Year: ${year}<br/>
            Corporate Ownership: ${
              data[hood]?.[year].corp_own_rate != null
                ? (data[hood][year].corp_own_rate * 100).toFixed(1) + "%"
                : "N/A"
            }<br/>
            Median Home Price: ${
              data[hood]?.[year].median_house_price != null
                ? "$" + data[hood][year].median_house_price.toLocaleString()
                : "N/A"
            }
          `;
            },

            updateTriggers: { getElevation: [scale, year], getFillColor: year },
          });
        }

        /* ------------------------------------------------------------------
         *  Rendering helpers
         * ----------------------------------------------------------------*/
        function updateYear(y) {
          // console.log("updating year");
          const year = Math.max(START_YEAR, Math.min(END_YEAR, Math.round(y)));
          sliderLabel.textContent = year;
          if (sliderEl.value !== String(year)) sliderEl.value = year;

          deckOverlay.setProps({ layers: [makeLayer({ scale: 1, year })] });
          // console.log("updating year: ", year);
          // console.log("corp rate: ", data["Allston"][year].corp_own_rate);
          // console.log(
          //   "house price: ",
          //   data["Allston"][year].median_house_price
          // );
        }

        function attachEvents() {
          /* Slider --------------------------------------------------------- */
          sliderEl.addEventListener("input", () => updateYear(+sliderEl.value));

          /* Parent iframe → child message listener ------------------------ */
          window.addEventListener("message", (e) => {
            if (typeof e.data?.year === "number") updateYear(e.data.year);
          });
        }

        /* ------------------------------------------------------------------
         *  Intro animation
         * ----------------------------------------------------------------*/
        function runIntroAnimation(year = INITIAL_YEAR) {
          const duration = 2000;
          const start = performance.now();

          (function animate() {
            const t = Math.min((performance.now() - start) / duration, 1);
            deckOverlay.setProps({ layers: [makeLayer({ scale: t, year })] });
            if (t < 1) requestAnimationFrame(animate);
          })();
        }

        /* ------------------------------------------------------------------
         *  Bootstrap
         * ----------------------------------------------------------------*/
        async function init() {
          await loadData();

          deckOverlay = new MapboxOverlay({
            interleaved: true,
            layers: [makeLayer({ scale: 1, year: INITIAL_YEAR })],
          });
          map.addControl(deckOverlay);

          attachEvents();
          runIntroAnimation(INITIAL_YEAR);
        }

        document.addEventListener("DOMContentLoaded", init);
      })();
    </script>
  </body>
</html>
